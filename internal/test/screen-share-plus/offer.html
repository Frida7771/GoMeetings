<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Share</title>
</head>
<body>
<div>
    <label>Room Identity:
        <input id="roomIdInput" type="text" placeholder="room identity">
    </label>
    <label>User Identity:
        <input id="userIdInput" type="text" value="offer">
    </label>
    <label>JWT Token:
        <input id="tokenInput" type="text" placeholder="optional token">
    </label>
    <button onclick="connectSignal()">连接信令</button>
</div>

<button onclick="createOffer()">点击开始共享</button>

当前共享的区域: <br>
<video id="localVideo" autoplay width="50%" height="auto"></video>

远程共享的区域: <br>
<video id="remoteVideo" autoplay width="50%" height="auto"></video>

<script>
    // 0. websocket 连接和监听
    // 1. 创建 PC
    // 2. 获取流
    // 3. 流添加到PC，创建 offer
    // 4. 监听 stream

    let roomIdentity = '';
    let userIdentity = 'offer';
    let ws = null;

    // {
    //     'user_identity': 'offer',
    //     'room_identity': '123456,
    //     'key': 'sdp',
    //     'value': 'any'
    // }

    function connectSignal() {
        const roomInput = document.getElementById('roomIdInput').value.trim();
        const userInput = document.getElementById('userIdInput').value.trim();
        const token = document.getElementById('tokenInput').value.trim();
        if (!roomInput || !userInput) {
            alert('请输入房间 ID 和用户 ID');
            return;
        }
        roomIdentity = roomInput;
        userIdentity = userInput;
        if (ws) {
            ws.close();
        }
        const wsUrl = `ws://127.0.0.1:8080/ws/p2p/${roomIdentity}/${userIdentity}` + (token ? `?token=${encodeURIComponent(token)}` : '');
        ws = new WebSocket(wsUrl);
        ws.addEventListener('message', handleSignalMessage);
        ws.addEventListener('open', () => console.log('signal connected'));
        ws.addEventListener('close', () => console.log('signal closed'));
    }

    function handleSignalMessage(event) {
        console.log(event.data)
        let data = JSON.parse(event.data)
        if (data.key === 'answer_sdp' && data.user_identity !== userIdentity) {
            pc.setRemoteDescription(data.value);
        }
        if (data.key === 'answer_candidate' && data.user_identity !== userIdentity) {
            pc.addIceCandidate(data.value);
        }
    }

    let pc = new RTCPeerConnection();

    // 远程流
    pc.onaddstream = function (e) {
        document.getElementById('remoteVideo').srcObject = e.stream;
    };

    // 候选者
    pc.onicecandidate = function (e) {
        if (e.candidate) {
            console.log('offer candidate', JSON.stringify(e.candidate));
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('请先连接信令服务');
                return;
            }
            ws.send(JSON.stringify({
                'user_identity': userIdentity,
                'room_identity': roomIdentity,
                'key': 'offer_candidate',
                'value': e.candidate
            }))
        }
    };

    function createOffer() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert('请先连接信令服务');
            return;
        }
        navigator.mediaDevices.getDisplayMedia().then(stream => {
            document.getElementById('localVideo').srcObject = stream;

            stream.getTracks().forEach(track => {
                pc.addTrack(track, stream);
            });

            pc.createOffer().then(offer => {
                console.log('offer', JSON.stringify(offer.sdp));
                ws.send(JSON.stringify({
                    'user_identity': userIdentity,
                    'room_identity': roomIdentity,
                    'key': 'offer_sdp',
                    'value': offer
                }));
                pc.setLocalDescription(offer);
            });
        })
    }

</script>
</body>
</html>